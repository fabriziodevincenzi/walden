---
import { getCollection } from 'astro:content';
import MainLayout from '../layouts/MainLayout.astro';
import ArticleCard from '../components/ArticleCard.astro';

// Get all articles
const allArticles = await getCollection('articles');

// Filter by category
const editorials = allArticles.filter(post => post.data.category === 'editoriale');
const reportage = allArticles.filter(post => post.data.category === 'reportage');
const excursions = allArticles.filter(post => post.data.category === 'escursione');
const multimedia = allArticles.filter(post => post.data.category === 'multimedia');

// Sort by date and featured with proper typing
interface Article {
  data: {
    pubDate: Date;
    featured: boolean;
  };
}

const sortByDateAndFeatured = (a: Article, b: Article) => {
  if (a.data.featured && !b.data.featured) return -1;
  if (!a.data.featured && b.data.featured) return 1;
  return b.data.pubDate.getTime() - a.data.pubDate.getTime();
};

editorials.sort(sortByDateAndFeatured);
reportage.sort(sortByDateAndFeatured);
excursions.sort(sortByDateAndFeatured);
multimedia.sort(sortByDateAndFeatured);
---

<MainLayout title="Home">
  <div class="magazine-layout">
    <!-- Editorial Column -->
    <div class="magazine-column">
      <h2 class="section-title">Editoriali</h2>
      {editorials.map(post => (
        <ArticleCard 
          title={post.data.title}
          description={post.data.description}
          pubDate={post.data.pubDate}
          author={post.data.author}
          category={post.data.category}
          featured={post.data.featured}
          tags={post.data.tags}
          cover={post.data.cover}
          url={`/articoli/${post.slug}`}
          size={post.data.featured ? 'large' : 'medium'}
        />
      ))}
    </div>

    <!-- Reportage Column -->
    <div class="magazine-column">
      <h2 class="section-title">Reportage</h2>
      {reportage.map(post => (
        <ArticleCard 
          article={post.data}
          url={`/articoli/${post.slug}`}
          size={post.data.featured ? 'large' : 'medium'}
        />
      ))}
    </div>

    <!-- Excursions Column -->
    <div class="magazine-column">
      <h2 class="section-title">Escursioni</h2>
      {excursions.map(post => (
        <ArticleCard 
          article={post.data}
          url={`/articoli/${post.slug}`}
          size="medium"
        />
      ))}
    </div>

    <!-- Multimedia Column -->
    <div class="magazine-column">
      <h2 class="section-title">Multimedia</h2>
      {multimedia.map(post => (
        <ArticleCard 
          article={post.data}
          url={`/articoli/${post.slug}`}
          size="medium"
          isMultimedia={true}
        />
      ))}
    </div>
  </div>
</MainLayout>

<style>
.magazine-layout {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: var(--space-xl);
  padding: var(--space-xl) 0;
}

.section-title {
  font-size: var(--font-size-xl);
  font-weight: 800;
  margin-bottom: var(--space-l);
  position: relative;
}

.section-title::after {
  content: "";
  display: block;
  width: 2rem;
  height: 2px;
  background: var(--color-primary);
  margin-top: var(--space-xs);
}

@media (max-width: 1024px) {
  .magazine-layout {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 768px) {
  .magazine-layout {
    grid-template-columns: 1fr;
  }
}
</style>